window.Messenger=function(){function a(a,b){var c="";if(arguments.length<2?c="target error - target and name are both requied":"object"!=typeof a?c="target error - target itself must be window object":"string"!=typeof b&&(c="target error - target name must be string type"),c)throw new Error(c);this.target=a,this.name=b}function b(a,b){this.targets={},this.name=a,this.listenFunc=[],c=b||c,this.initListen()}var c="[PROJECT_NAME]",d="postMessage"in window;return d?a.prototype.send=function(a){this.target.postMessage(c+a,"*")}:a.prototype.send=function(a){var b=window.navigator[c+this.name];if("function"!=typeof b)throw new Error("target callback function is not defined");b(c+a,window)},b.prototype.addTarget=function(b,c){var d=new a(b,c);this.targets[c]=d},b.prototype.initListen=function(){var a=this,b=function(b){"object"==typeof b&&b.data&&(b=b.data),b=b.slice(c.length);for(var d=0;d<a.listenFunc.length;d++)a.listenFunc[d](b)};d?"addEventListener"in document?window.addEventListener("message",b,!1):"attachEvent"in document&&window.attachEvent("onmessage",b):window.navigator[c+this.name]=b},b.prototype.listen=function(a){this.listenFunc.push(a)},b.prototype.clear=function(){this.listenFunc=[]},b.prototype.send=function(a){var b,c=this.targets;for(b in c)c.hasOwnProperty(b)&&c[b].send(a)},b}(),function(a){var b=a.$,c=a.$.ajax,d=a.$.Deferred,e=a.SnapPea||{},f=(e.Utils,e.AliOpen);b.ajaxSetup&&b.ajaxSetup({xhrFields:{withCredentials:!0}});var g=".w-account-hook-opened {overflow: hidden;}.w-account-hook-backdrop {background: #4C4C4C;background: url(http://img.wdjimg.com/account/overlay.png);background: rgba(0, 0, 0, .7);bottom: 0;left: 0;opacity: 0;position: fixed;right: 0;top: 0;z-index: 999;-webkit-transition: opacity .15s linear;-moz-transition: opacity .15s linear;-o-transition: opacity .15s linear;transition: opacity .15s linear;}.w-account-hook-backdrop-in {opacity: 1;}.w-account-hook-iframe {border: none;border-radius: 10px;left: 50%;height: 200px;margin: 0 0 0 -208px;position: fixed;top: 10%;width: 434px;-webkit-transform: translate3d(0, -200%, 0);-moz-transform: translate3d(0, -200%, 0);-ms-transform: translate3d(0, -200%, 0);-o-transform: translate3d(0, -200%, 0);transform: translate3d(0, -200%, 0);-webkit-transition: height .3s linear, -webkit-transform .3s ease-in-out;-moz-transition: height .3s linear, -moz-transform .3s ease-in-out;-o-transition: height .3s linear, -o-transform .3s ease-in-out;transition: height .3s linear, transform .3s ease-in-out;}.w-account-hook-iframe-in {-webkit-transform: translate3d(0, 0, 0);-moz-transform: translate3d(0, 0, 0);-ms-transform: translate3d(0, 0, 0);-o-transform: translate3d(0, 0, 0);transform: translate3d(0, 0, 0);}",h=function(){var a=document.createElement("snappea"),b={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",MSTransition:"msTransitionEnd",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var c in b)if(void 0!==a.style[c])return b[c];return!1}();b.fn.transitionEnd=function(a,c){var d=this,e=!1;return h===!1?(a.call(d),this):(b(this).one(h,function(){e=!0,a.call(d)}),setTimeout(function(){e||a.call(d)},c+200),this)};var i=!!window.OneRingRequest,j=function(a){var b=new d;a=a||{},a.data=a.data||{},a.type=a.type||"get",a.url=a.url||"";var c=a.url,e=function(c){c=JSON.parse(c),c.state_line=c.state_line||c.state_code,console.log("IO - Callback message for '"+a.url+"'",c),b.resolve(c)};switch(a.type.toLowerCase()){case"get":var f,g=[];for(f in a.data)a.data.hasOwnProperty(f)&&g.push(f+"="+window.encodeURIComponent(a.data[f]));g.length>0&&(c=c+"?"+g.join("&")),window.OneRingRequest(a.type,c,null,e);break;case"post":window.OneRingRequest(a.type,c,window.encodeURIComponent(JSON.stringify(a.data)),e)}return console.log("IO - AJAX call: "+a.url,a),b.promise()},k={},l={checkUserLogin:"https://account.wandoujia.com/v4/api/profile"};k.checkAsync=function(a,b){var e=new d,g={isLoggedIn:!1,data:{}};return window.location.href.indexOf(f.postfix)>-1&&(b.from=f.from.aliOpen),b=b||{},b&&b.from===f.from.aliOpen&&(l.checkUserLogin=f.host+"/v4/api/profile"),c({type:"GET",dataType:"jsonp",url:l.checkUserLogin,data:a||{},success:function(a){0===a.error?(g.isLoggedIn=!0,g.data=a.member,e.resolve(g)):1000004===a.error?(a.redirectInfo&&(g.data=a.redirectInfo),e.reject(g)):1013===a.error?(g.data.error=a.error,e.reject(g)):e.reject(g)},error:function(){e.reject(g)}}),e.promise()};var m;b("head").append('<style type="text/css">'+g+"</style>"),k.openAsync=function(c,e){var g=new d,h={isLoggedIn:!1,data:{}},l="";if(c=c&&c.toLowerCase()||"login",e=e||{},i){switch(c){case"login":l="wdj://account/login.json";break;case"register":l="wdj://account/register.json";break;case"find":l="wdj://account/reset.json";break;case"logout":l="wdj://account/logout.json"}if(l)return j({url:l}).then(function(){var a,b=function(a){clearInterval(m),g.resolve(a)};a="logout"!==c?function(){k.checkAsync().then(b)}:function(){k.checkAsync().fail(b)},clearInterval(m),m=setInterval(a,500)}),g.promise()}var n,o=[];for(n in e)e.hasOwnProperty(n)&&o.push(n+"="+a.encodeURIComponent(e[n]));l="//www.wandoujia.com/account/?source=web&medium="+encodeURIComponent(location.host+location.pathname)+"&close=1&"+o.join("&")+"#"+c,e&&e.from===f.from.aliOpen&&(l="//"+window.location.host+"?source=web&medium="+encodeURIComponent(location.host+location.pathname)+"&close=1&"+o.join("&")+"#"+c);var p,q=b("body").addClass("w-account-hook-opened"),r=b("<div>").addClass("w-account-hook-backdrop").appendTo(q),s=b("<iframe>").attr({src:l,frameBorder:0}).addClass("w-account-hook-iframe").appendTo(r);p=r[0].offsetWidth,r.addClass("w-account-hook-backdrop-in");var t=new a.Messenger("parent","Account");t.addTarget(s[0].contentWindow,"iframe");var u=function(){s.removeClass("w-account-hook-iframe-in"),r.removeClass("w-account-hook-backdrop-in").transitionEnd(function(){r.remove()},150),q.removeClass("w-account-hook-opened")},v=!1;return t.listen(function(b){var c=b.split(":"),d=decodeURIComponent(c[1]);switch(c[0]){case"height":navigator.userAgent.toLowerCase().indexOf("msie")>-1&&(d=Number(d)+4),s.css("height",d+"px"),v||s.transitionEnd(function(){s.addClass("w-account-hook-iframe-in"),v=!0},300);break;case"close":u(),g.reject(h);break;case"done":window.location.href.indexOf(f.postfix)>-1?k.checkAsync({},{from:f.from.aliOpen}).always(function(a){u(),g.resolve(a)}):k.checkAsync().always(function(a){u(),g.resolve(a)});break;case"redirect":a.document.location.href=d}}),r.one("click",u),g.promise()},k.redirect=function(a){var b="//www.wandoujia.com/account/web.html?callback="+encodeURIComponent(location.href)+"#"+a;location.href=b},e.AccountHook=k,a.SnapPea=e}(this);